<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Group Scheduler</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-primary: #22c55e;
            --accent-secondary: #16a34a;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-tournament: #8b5cf6;
            --accent-scramble: #06b6d4;
            --accent-bestball: #ec4899;
            --accent-off: #64748b;
            --border-color: #475569;
            --radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        h1 {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--accent-primary), #4ade80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle { color: var(--text-secondary); font-size: 1rem; }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 28px;
        }

        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        .btn-primary:hover { background: var(--accent-secondary); }

        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-outline:hover { background: var(--bg-tertiary); }

        .btn-sm { padding: 6px 14px; font-size: 0.8rem; }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        input[type="text"], input[type="number"], input[type="date"] {
            flex: 1;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .player-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 0.9rem;
        }
        .tag-remove:hover { opacity: 1; color: var(--accent-danger); }

        .week-selector {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .week-input {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        .week-input input {
            width: 70px;
            text-align: center;
        }

        /* Week config grid - now with more columns */
        .week-config-grid {
            display: grid;
            grid-template-columns: auto 100px 1fr auto;
            gap: 8px;
            margin-top: 12px;
            align-items: center;
        }

        .week-config-header {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            padding-bottom: 4px;
        }

        .week-name-input {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.8rem;
            width: 100%;
        }

        .week-date-input {
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.75rem;
            width: 100px;
        }

        .week-type-select {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.75rem;
            cursor: pointer;
            min-width: 110px;
        }

        .week-type-select.regular { border-color: var(--border-color); }
        .week-type-select.aggregate { border-color: var(--accent-warning); background: rgba(245, 158, 11, 0.1); }
        .week-type-select.tournament { border-color: var(--accent-tournament); background: rgba(139, 92, 246, 0.1); }
        .week-type-select.scramble { border-color: var(--accent-scramble); background: rgba(6, 182, 212, 0.1); }
        .week-type-select.bestball { border-color: var(--accent-bestball); background: rgba(236, 72, 153, 0.1); }
        .week-type-select.off { border-color: var(--accent-off); background: rgba(100, 116, 139, 0.2); }

        .week-label {
            font-size: 0.85rem;
            font-weight: 500;
            min-width: 50px;
        }

        .availability-grid {
            overflow-x: auto;
        }

        .availability-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .availability-table th,
        .availability-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .availability-table th {
            background: var(--bg-tertiary);
            font-weight: 500;
        }

        .availability-table th.regular { }
        .availability-table th.aggregate { background: rgba(245, 158, 11, 0.15); color: var(--accent-warning); }
        .availability-table th.tournament { background: rgba(139, 92, 246, 0.15); color: var(--accent-tournament); }
        .availability-table th.scramble { background: rgba(6, 182, 212, 0.15); color: var(--accent-scramble); }
        .availability-table th.bestball { background: rgba(236, 72, 153, 0.15); color: var(--accent-bestball); }
        .availability-table th.off { background: rgba(100, 116, 139, 0.2); color: var(--accent-off); }

        .availability-table td {
            cursor: pointer;
            transition: background 0.2s;
        }

        .availability-table td.available {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-primary);
        }

        .availability-table td.disabled {
            background: rgba(100, 116, 139, 0.15);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .availability-table td:hover:not(.disabled) {
            background: var(--bg-tertiary);
        }

        .pair-section {
            margin-bottom: 18px;
        }

        .pair-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .pair-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .pair-tag.preferred {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--accent-primary);
        }

        .pair-tag.forbidden {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-danger);
        }

        select {
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 14px;
        }

        .iteration-control {
            display: flex;
            align-items: center;
            gap: 14px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        input[type="range"] {
            width: 140px;
            accent-color: var(--accent-primary);
        }

        .iteration-value {
            color: var(--accent-primary);
            font-weight: 600;
            min-width: 50px;
        }

        .schedule-output {
            min-height: 300px;
            overflow: auto;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Player-column Schedule Table */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .schedule-table th,
        .schedule-table td {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .schedule-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .schedule-table th.week-info-header {
            text-align: left;
            min-width: 120px;
        }

        .schedule-table th.type-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            min-width: 40px;
            padding: 10px 6px;
        }

        .schedule-table th.player-header {
            min-width: 80px;
        }

        .schedule-table tr.week-row {
            background: rgba(30, 41, 59, 0.5);
        }

        .schedule-table tr.week-row:hover {
            background: rgba(30, 41, 59, 0.8);
        }

        .schedule-table tr.week-row.regular { }
        .schedule-table tr.week-row.aggregate { border-left: 4px solid var(--accent-warning); }
        .schedule-table tr.week-row.tournament { border-left: 4px solid var(--accent-tournament); }
        .schedule-table tr.week-row.scramble { border-left: 4px solid var(--accent-scramble); }
        .schedule-table tr.week-row.bestball { border-left: 4px solid var(--accent-bestball); }
        .schedule-table tr.week-row.off { border-left: 4px solid var(--accent-off); background: rgba(100, 116, 139, 0.1); }

        .schedule-table .week-info-cell {
            text-align: left;
            font-weight: 500;
        }

        .schedule-table .week-info-cell .week-num {
            font-weight: 600;
            color: var(--text-primary);
        }

        .schedule-table .week-info-cell .week-date {
            color: var(--text-secondary);
            font-size: 0.7rem;
            display: block;
        }

        .schedule-table .week-info-cell .week-course {
            color: var(--accent-primary);
            font-size: 0.75rem;
            display: block;
        }

        .schedule-table .type-cell {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 8px 4px;
        }

        .schedule-table .type-cell.regular { color: var(--text-secondary); }
        .schedule-table .type-cell.aggregate { color: var(--accent-warning); }
        .schedule-table .type-cell.tournament { color: var(--accent-tournament); }
        .schedule-table .type-cell.scramble { color: var(--accent-scramble); }
        .schedule-table .type-cell.bestball { color: var(--accent-bestball); }
        .schedule-table .type-cell.off { color: var(--accent-off); }

        .schedule-table .player-cell {
            font-weight: 500;
        }

        .schedule-table .player-cell.partner {
            color: var(--accent-primary);
            background: rgba(34, 197, 94, 0.08);
        }

        .schedule-table .player-cell.alone {
            color: var(--accent-warning);
            background: rgba(245, 158, 11, 0.08);
            font-style: italic;
        }

        .schedule-table .player-cell.not-playing {
            color: var(--text-secondary);
            background: rgba(100, 116, 139, 0.05);
        }

        .schedule-table .player-cell.playing {
            color: var(--accent-scramble);
            background: rgba(6, 182, 212, 0.08);
        }

        /* Tournament manual pairing section */
        .tournament-pairing-section {
            margin-top: 16px;
            padding: 16px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
        }

        .tournament-pairing-section h4 {
            font-size: 0.9rem;
            color: var(--accent-tournament);
            margin-bottom: 12px;
        }

        .tournament-week-select {
            margin-bottom: 12px;
        }

        .manual-pair-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .manual-pair-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .manual-pair-row select {
            flex: 1;
            padding: 6px;
            font-size: 0.8rem;
        }

        /* Singles Summary Table */
        .singles-summary {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .singles-summary h4 {
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: var(--accent-warning);
        }

        .singles-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .singles-table th,
        .singles-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .singles-table th {
            background: var(--bg-secondary);
            font-weight: 500;
        }

        .singles-table td.count {
            text-align: center;
            font-weight: 600;
        }

        .singles-table td.count.high { color: var(--accent-danger); }
        .singles-table td.count.medium { color: var(--accent-warning); }
        .singles-table td.count.low { color: var(--accent-primary); }

        .singles-table td.weeks {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 18px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .score-display {
            text-align: center;
            padding: 18px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 10px;
        }

        .score-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .score-value {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), #4ade80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .export-btns {
            display: flex;
            gap: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            height: 3px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), #4ade80);
            width: 0;
            transition: width 0.3s;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .separator {
            height: 1px;
            background: var(--border-color);
            margin: 20px 0;
        }

        .scroll-area {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .legend {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 0.75rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .legend-dot.regular { background: var(--bg-tertiary); border: 1px solid var(--border-color); }
        .legend-dot.aggregate { background: rgba(245, 158, 11, 0.5); border: 1px solid var(--accent-warning); }
        .legend-dot.tournament { background: rgba(139, 92, 246, 0.5); border: 1px solid var(--accent-tournament); }
        .legend-dot.scramble { background: rgba(6, 182, 212, 0.5); border: 1px solid var(--accent-scramble); }
        .legend-dot.bestball { background: rgba(236, 72, 153, 0.5); border: 1px solid var(--accent-bestball); }
        .legend-dot.off { background: rgba(100, 116, 139, 0.5); border: 1px solid var(--accent-off); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚õ≥ Golf Group Scheduler</h1>
            <p class="subtitle">Optimize pairings for golf or any group activity</p>
        </header>

        <div class="main-grid">
            <!-- Configuration Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚öôÔ∏è Configuration</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-outline btn-sm" onclick="loadExample()">üìÑ Example</button>
                        <button class="btn btn-outline btn-sm" onclick="clearAll()">üóëÔ∏è Clear</button>
                    </div>
                </div>

                <div class="scroll-area">
                    <!-- Players Section -->
                    <div class="section">
                        <div class="section-title">üë• Players (Fixed Order for Season)</div>
                        <div class="input-row">
                            <input type="text" id="newPlayer" placeholder="Enter player name..." onkeypress="if(event.key==='Enter')addPlayer()">
                            <button class="btn btn-primary btn-sm" onclick="addPlayer()">+ Add</button>
                        </div>
                        <div class="player-tags" id="playerTags"></div>
                    </div>

                    <div class="separator"></div>

                    <!-- Weeks Section -->
                    <div class="section">
                        <div class="section-title">üìÖ Weeks Configuration</div>
                        <div class="week-selector">
                            <div class="week-input">
                                <span>Number of weeks:</span>
                                <input type="number" id="weekCount" value="6" min="1" max="52" onchange="updateWeeks()">
                            </div>
                        </div>
                        <div class="legend" style="margin-top: 12px;">
                            <div class="legend-item"><div class="legend-dot regular"></div><span>Regular</span></div>
                            <div class="legend-item"><div class="legend-dot aggregate"></div><span>Aggregate</span></div>
                            <div class="legend-item"><div class="legend-dot tournament"></div><span>Tournament</span></div>
                            <div class="legend-item"><div class="legend-dot scramble"></div><span>Scramble</span></div>
                            <div class="legend-item"><div class="legend-dot bestball"></div><span>Best Ball</span></div>
                            <div class="legend-item"><div class="legend-dot off"></div><span>Off/Memorial</span></div>
                        </div>
                        <div class="week-config-grid" id="weekConfigGrid"></div>
                    </div>

                    <div class="separator"></div>

                    <!-- Availability Section -->
                    <div class="section">
                        <div class="section-title">‚úì Availability</div>
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Click cells to toggle availability (Off/Memorial weeks disabled)</p>
                        <div class="availability-grid">
                            <table class="availability-table" id="availabilityTable"></table>
                        </div>
                    </div>

                    <div class="separator"></div>

                    <!-- Tournament Manual Pairing -->
                    <div class="section" id="tournamentSection" style="display: none;">
                        <div class="tournament-pairing-section">
                            <h4>üèÜ Tournament Manual Pairings</h4>
                            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 12px;">
                                Override automatic pairings for tournament weeks only
                            </p>
                            <div class="tournament-week-select">
                                <label style="font-size: 0.8rem;">Select tournament week: </label>
                                <select id="tournamentWeekSelect" onchange="renderTournamentPairings()"></select>
                            </div>
                            <div id="tournamentPairingGrid"></div>
                        </div>
                    </div>

                    <!-- Pair Preferences Section -->
                    <div class="section">
                        <div class="section-title">üíö Preferred Pairs</div>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px;">Preferred pairs are prioritized on Aggregate events only</p>
                        <div class="input-row">
                            <select id="preferred1"></select>
                            <select id="preferred2"></select>
                            <input type="number" id="preferredMax" value="2" min="1" max="10" style="width: 60px;" placeholder="Max">
                            <button class="btn btn-primary btn-sm" onclick="addPreferredPair()">+ Add</button>
                        </div>
                        <div class="pair-list" id="preferredPairs"></div>
                    </div>

                    <div class="section">
                        <div class="section-title">üö´ Forbidden Pairs</div>
                        <div class="input-row">
                            <select id="forbidden1"></select>
                            <select id="forbidden2"></select>
                            <button class="btn btn-outline btn-sm" onclick="addForbiddenPair()">+ Add</button>
                        </div>
                        <div class="pair-list" id="forbiddenPairs"></div>
                    </div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìã Schedule Output</div>
                    <div class="export-btns">
                        <button class="btn btn-outline btn-sm" onclick="copyOutput()">üìã Copy</button>
                        <button class="btn btn-primary btn-sm" onclick="exportCSV()">üì• Export CSV</button>
                    </div>
                </div>

                <div class="controls-bar">
                    <div class="iteration-control">
                        <span>Iterations:</span>
                        <input type="range" id="iterations" min="100" max="10000" value="2000" step="100" oninput="updateIterationDisplay()">
                        <span class="iteration-value" id="iterationDisplay">2000</span>
                    </div>
                    <button class="btn btn-primary" onclick="generateSchedule()">üöÄ Generate Schedule</button>
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Generating optimal schedule...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="schedule-output" id="scheduleOutput">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Configure players and weeks, then click Generate Schedule</p>
                    </div>
                </div>

                <div id="singlesSection" style="display: none;"></div>

                <div id="statsSection" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statUnique">0</div>
                            <div class="stat-label">Unique Pairings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statSingles">0</div>
                            <div class="stat-label">Playing Alone</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statPreferred">0</div>
                            <div class="stat-label">Preferred Pairs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statRepeats">0</div>
                            <div class="stat-label">Pair Repeats</div>
                        </div>
                    </div>
                    <div class="score-display">
                        <div class="score-label">Optimization Score</div>
                        <div class="score-value" id="scoreValue">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Event types
        const EVENT_TYPES = ['regular', 'aggregate', 'tournament', 'scramble', 'bestball', 'off'];
        const EVENT_LABELS = {
            regular: 'Regular',
            aggregate: 'Aggregate',
            tournament: 'Tournament',
            scramble: 'Scramble',
            bestball: 'Best Ball',
            off: 'Off/Memorial'
        };

        // State
        let state = {
            players: [],
            weekCount: 6,
            weekTypes: {},        // week -> event type
            weekDates: {},        // week -> date string
            weekNames: {},        // week -> course/place name
            availability: {},
            preferredPairs: new Map(),
            forbiddenPairs: new Set(),
            tournamentPairings: {} // week -> array of {a, b} manual pairs
        };

        let currentSchedule = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateWeeks();
            updatePlayerSelects();
        });

        // Player Management
        function addPlayer() {
            const input = document.getElementById('newPlayer');
            const name = input.value.trim();
            if (name && !state.players.includes(name)) {
                state.players.push(name);
                input.value = '';
                renderPlayers();
                updateAvailabilityGrid();
                updatePlayerSelects();
            }
        }

        function removePlayer(name) {
            state.players = state.players.filter(p => p !== name);
            for (let week in state.availability) {
                state.availability[week] = state.availability[week].filter(p => p !== name);
            }
            renderPlayers();
            updateAvailabilityGrid();
            updatePlayerSelects();
        }

        function renderPlayers() {
            const container = document.getElementById('playerTags');
            container.innerHTML = state.players.map((p, idx) => `
                <span class="tag">
                    <span style="color: var(--text-secondary); font-size: 0.7rem;">${idx + 1}.</span>
                    ${p}
                    <span class="tag-remove" onclick="removePlayer('${p}')">√ó</span>
                </span>
            `).join('');
        }

        // Week Management
        function updateWeeks() {
            state.weekCount = parseInt(document.getElementById('weekCount').value) || 6;
            
            // Clean up data beyond week count
            const cleanedTypes = {};
            const cleanedDates = {};
            const cleanedNames = {};
            for (let i = 1; i <= state.weekCount; i++) {
                const key = String(i);
                cleanedTypes[key] = state.weekTypes[key] || 'regular';
                if (state.weekDates[key]) cleanedDates[key] = state.weekDates[key];
                if (state.weekNames[key]) cleanedNames[key] = state.weekNames[key];
            }
            state.weekTypes = cleanedTypes;
            state.weekDates = cleanedDates;
            state.weekNames = cleanedNames;
            
            renderWeekConfig();
            updateAvailabilityGrid();
            updateTournamentSection();
        }

        function renderWeekConfig() {
            const container = document.getElementById('weekConfigGrid');
            let html = `
                <div class="week-config-header">Week</div>
                <div class="week-config-header">Date</div>
                <div class="week-config-header">Course/Place</div>
                <div class="week-config-header">Type</div>
            `;
            
            for (let i = 1; i <= state.weekCount; i++) {
                const weekKey = String(i);
                const weekType = state.weekTypes[weekKey] || 'regular';
                const weekDate = state.weekDates[weekKey] || '';
                const weekName = state.weekNames[weekKey] || '';
                
                html += `
                    <span class="week-label">Week ${i}</span>
                    <input type="date" class="week-date-input" value="${weekDate}" 
                        onchange="updateWeekDate('${weekKey}', this.value)">
                    <input type="text" class="week-name-input" value="${weekName}" 
                        placeholder="e.g., Pine Valley" 
                        onchange="updateWeekName('${weekKey}', this.value)">
                    <select class="week-type-select ${weekType}" onchange="updateWeekType('${weekKey}', this.value)">
                        ${EVENT_TYPES.map(t => `<option value="${t}" ${weekType === t ? 'selected' : ''}>${EVENT_LABELS[t]}</option>`).join('')}
                    </select>
                `;
            }
            container.innerHTML = html;
        }

        function updateWeekType(week, type) {
            state.weekTypes[week] = type;
            // Update the select styling
            const selects = document.querySelectorAll('.week-type-select');
            selects.forEach(sel => {
                sel.className = 'week-type-select ' + sel.value;
            });
            updateAvailabilityGrid();
            updateTournamentSection();
        }

        function updateWeekDate(week, date) {
            if (date) {
                state.weekDates[week] = date;
            } else {
                delete state.weekDates[week];
            }
        }

        function updateWeekName(week, name) {
            if (name.trim()) {
                state.weekNames[week] = name.trim();
            } else {
                delete state.weekNames[week];
            }
        }

        // Tournament Section
        function updateTournamentSection() {
            const tournamentWeeks = [];
            for (let i = 1; i <= state.weekCount; i++) {
                const key = String(i);
                if (state.weekTypes[key] === 'tournament') {
                    tournamentWeeks.push(key);
                }
            }

            const section = document.getElementById('tournamentSection');
            if (tournamentWeeks.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            const select = document.getElementById('tournamentWeekSelect');
            select.innerHTML = tournamentWeeks.map(w => {
                const name = state.weekNames[w];
                const label = name ? `Week ${w} (${name})` : `Week ${w}`;
                return `<option value="${w}">${label}</option>`;
            }).join('');

            renderTournamentPairings();
        }

        function renderTournamentPairings() {
            const week = document.getElementById('tournamentWeekSelect').value;
            if (!week) return;

            const available = state.availability[week] || [];
            const grid = document.getElementById('tournamentPairingGrid');

            if (available.length < 2) {
                grid.innerHTML = '<p style="font-size: 0.8rem; color: var(--text-secondary);">Set player availability for this week first</p>';
                return;
            }

            // Initialize tournament pairings for this week if not exists
            if (!state.tournamentPairings[week]) {
                state.tournamentPairings[week] = [];
            }

            const numPairs = Math.floor(available.length / 2);
            let html = '<div class="manual-pair-grid">';

            for (let p = 0; p < numPairs; p++) {
                const existingPair = state.tournamentPairings[week][p] || {};
                html += `
                    <div class="manual-pair-row">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Pair ${p + 1}:</span>
                        <select onchange="updateTournamentPair('${week}', ${p}, 'a', this.value)">
                            <option value="">Select</option>
                            ${available.map(pl => `<option value="${pl}" ${existingPair.a === pl ? 'selected' : ''}>${pl}</option>`).join('')}
                        </select>
                        <span>+</span>
                        <select onchange="updateTournamentPair('${week}', ${p}, 'b', this.value)">
                            <option value="">Select</option>
                            ${available.map(pl => `<option value="${pl}" ${existingPair.b === pl ? 'selected' : ''}>${pl}</option>`).join('')}
                        </select>
                    </div>
                `;
            }

            html += '</div>';
            grid.innerHTML = html;
        }

        function updateTournamentPair(week, pairIndex, side, player) {
            if (!state.tournamentPairings[week]) {
                state.tournamentPairings[week] = [];
            }
            if (!state.tournamentPairings[week][pairIndex]) {
                state.tournamentPairings[week][pairIndex] = {};
            }
            state.tournamentPairings[week][pairIndex][side] = player;
        }

        // Availability Grid
        function updateAvailabilityGrid() {
            const table = document.getElementById('availabilityTable');
            
            if (state.players.length === 0) {
                table.innerHTML = '<tr><td style="padding: 20px; color: var(--text-secondary);">Add players to see availability grid</td></tr>';
                return;
            }

            let html = '<tr><th>Player</th>';
            for (let i = 1; i <= state.weekCount; i++) {
                const weekKey = String(i);
                const weekType = state.weekTypes[weekKey] || 'regular';
                const weekName = state.weekNames[weekKey];
                const title = weekName ? `Week ${i}: ${weekName}` : `Week ${i}`;
                html += `<th class="${weekType}" title="${title}">W${i}</th>`;
            }
            html += '</tr>';

            state.players.forEach(player => {
                html += `<tr><td style="text-align: left; font-weight: 500;">${player}</td>`;
                for (let i = 1; i <= state.weekCount; i++) {
                    const week = String(i);
                    const weekType = state.weekTypes[week] || 'regular';
                    const isOff = weekType === 'off';
                    const isAvailable = state.availability[week]?.includes(player);
                    
                    if (isOff) {
                        html += `<td class="disabled">‚Äî</td>`;
                    } else {
                        html += `<td class="${isAvailable ? 'available' : ''}" onclick="toggleAvailability('${player}', '${week}')">${isAvailable ? '‚úì' : ''}</td>`;
                    }
                }
                html += '</tr>';
            });

            table.innerHTML = html;
        }

        function toggleAvailability(player, week) {
            const weekType = state.weekTypes[week] || 'regular';
            if (weekType === 'off') return; // Can't toggle Off weeks

            if (!state.availability[week]) {
                state.availability[week] = [];
            }
            const idx = state.availability[week].indexOf(player);
            if (idx >= 0) {
                state.availability[week].splice(idx, 1);
            } else {
                state.availability[week].push(player);
            }
            updateAvailabilityGrid();
            renderTournamentPairings();
        }

        // Player Selects for Pairs
        function updatePlayerSelects() {
            const selects = ['preferred1', 'preferred2', 'forbidden1', 'forbidden2'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">Select player</option>' +
                    state.players.map(p => `<option value="${p}">${p}</option>`).join('');
            });
        }

        // Preferred Pairs
        function addPreferredPair() {
            const p1 = document.getElementById('preferred1').value;
            const p2 = document.getElementById('preferred2').value;
            const max = parseInt(document.getElementById('preferredMax').value) || 2;

            if (p1 && p2 && p1 !== p2) {
                const key = [p1, p2].sort().join('|');
                state.preferredPairs.set(key, max);
                renderPreferredPairs();
            }
        }

        function removePreferredPair(key) {
            state.preferredPairs.delete(key);
            renderPreferredPairs();
        }

        function renderPreferredPairs() {
            const container = document.getElementById('preferredPairs');
            const pairs = [...state.preferredPairs.entries()];
            container.innerHTML = pairs.map(([key, max]) => {
                const [p1, p2] = key.split('|');
                return `<span class="pair-tag preferred">
                    ${p1} + ${p2} (max ${max})
                    <span class="tag-remove" onclick="removePreferredPair('${key}')">√ó</span>
                </span>`;
            }).join('');
        }

        // Forbidden Pairs
        function addForbiddenPair() {
            const p1 = document.getElementById('forbidden1').value;
            const p2 = document.getElementById('forbidden2').value;

            if (p1 && p2 && p1 !== p2) {
                const key = [p1, p2].sort().join('|');
                state.forbiddenPairs.add(key);
                renderForbiddenPairs();
            }
        }

        function removeForbiddenPair(key) {
            state.forbiddenPairs.delete(key);
            renderForbiddenPairs();
        }

        function renderForbiddenPairs() {
            const container = document.getElementById('forbiddenPairs');
            const pairs = [...state.forbiddenPairs];
            container.innerHTML = pairs.map(key => {
                const [p1, p2] = key.split('|');
                return `<span class="pair-tag forbidden">
                    ${p1} + ${p2}
                    <span class="tag-remove" onclick="removeForbiddenPair('${key}')">√ó</span>
                </span>`;
            }).join('');
        }

        // Iteration Display
        function updateIterationDisplay() {
            document.getElementById('iterationDisplay').textContent = document.getElementById('iterations').value;
        }

        // Schedule Generation
        function buildSchedule() {
            const schedule = {};
            const pairCounts = new Map();
            const sitOuts = new Map();
            const sitOutWeeks = new Map();

            state.players.forEach(p => {
                sitOuts.set(p, 0);
                sitOutWeeks.set(p, []);
            });

            for (let w = 1; w <= state.weekCount; w++) {
                const week = String(w);
                const weekType = state.weekTypes[week] || 'regular';

                // Off/Memorial weeks: no pairings
                if (weekType === 'off') {
                    schedule[week] = [];
                    continue;
                }

                const available = [...(state.availability[week] || [])];
                if (available.length === 0) {
                    schedule[week] = [];
                    continue;
                }

                // Tournament weeks: use manual pairings if available
                if (weekType === 'tournament' && state.tournamentPairings[week]) {
                    const manualPairs = state.tournamentPairings[week].filter(p => p.a && p.b && p.a !== p.b);
                    if (manualPairs.length > 0) {
                        const pairings = [];
                        const paired = new Set();

                        manualPairs.forEach(pair => {
                            if (available.includes(pair.a) && available.includes(pair.b)) {
                                pairings.push({ a: pair.a, b: pair.b });
                                paired.add(pair.a);
                                paired.add(pair.b);
                                const key = [pair.a, pair.b].sort().join('|');
                                pairCounts.set(key, (pairCounts.get(key) || 0) + 1);
                            }
                        });

                        // Remaining unpaired players play alone
                        available.filter(p => !paired.has(p)).forEach(p => {
                            pairings.push({ sitout: p });
                            sitOuts.set(p, (sitOuts.get(p) || 0) + 1);
                            sitOutWeeks.get(p).push(w);
                        });

                        schedule[week] = pairings;
                        continue;
                    }
                }

                // Normal auto-pairing logic
                const isAggregateWeek = weekType === 'aggregate';
                const pairings = [];
                const shuffled = [...available].sort(() => Math.random() - 0.5);
                const paired = new Set();

                for (let i = 0; i < shuffled.length; i++) {
                    if (paired.has(shuffled[i])) continue;

                    let bestPartner = null;
                    let bestScore = -Infinity;

                    for (let j = i + 1; j < shuffled.length; j++) {
                        if (paired.has(shuffled[j])) continue;

                        const a = shuffled[i], b = shuffled[j];
                        const key = [a, b].sort().join('|');

                        if (state.forbiddenPairs.has(key)) continue;

                        let score = 0;
                        const count = pairCounts.get(key) || 0;

                        if (count === 0) score += 10;

                        // Preferred pairs ONLY on aggregate weeks
                        const limit = state.preferredPairs.get(key);
                        if (limit && count < limit && isAggregateWeek) {
                            score += 25;
                        }

                        if (count > 0) score -= count * 3;

                        if (score > bestScore) {
                            bestScore = score;
                            bestPartner = j;
                        }
                    }

                    if (bestPartner !== null) {
                        const a = shuffled[i], b = shuffled[bestPartner];
                        const key = [a, b].sort().join('|');
                        pairings.push({ a, b });
                        paired.add(a);
                        paired.add(b);
                        pairCounts.set(key, (pairCounts.get(key) || 0) + 1);
                    }
                }

                shuffled.filter(p => !paired.has(p)).forEach(p => {
                    pairings.push({ sitout: p });
                    sitOuts.set(p, (sitOuts.get(p) || 0) + 1);
                    sitOutWeeks.get(p).push(w);
                });

                schedule[week] = pairings;
            }

            return { schedule, pairCounts, sitOuts, sitOutWeeks };
        }

        function calculateScore(result) {
            let score = 0;
            const { pairCounts, sitOuts } = result;

            let uniquePairs = 0;
            pairCounts.forEach((count) => {
                if (count === 1) { score += 16; uniquePairs++; }
                else if (count === 2) score += 8;
                else score -= (count - 2) * 3;
            });

            let totalSitouts = 0;
            sitOuts.forEach(count => {
                totalSitouts += count;
                if (count === 0) score += 6;
                else if (count === 1) score += 3;
                else score -= (count - 1) * 6;
            });

            let preferredUsed = 0;
            state.preferredPairs.forEach((limit, key) => {
                const count = pairCounts.get(key) || 0;
                if (count > 0 && count <= limit) {
                    score += 7 * (limit - count + 1);
                    preferredUsed += count;
                } else if (count > limit) {
                    score -= (count - limit) * 50;
                }
            });

            state.forbiddenPairs.forEach(key => {
                const count = pairCounts.get(key) || 0;
                if (count > 0) score -= count * 100;
            });

            const pairRepeats = [...pairCounts.values()].reduce((a, b) => a + Math.max(0, b - 1), 0);

            return {
                score: Math.round(score),
                stats: { uniquePairs, totalSitouts, preferredUsed, pairRepeats }
            };
        }

        async function generateSchedule() {
            if (state.players.length < 2) {
                alert('Please add at least 2 players');
                return;
            }

            const iterations = parseInt(document.getElementById('iterations').value);

            document.getElementById('loading').style.display = 'block';
            document.getElementById('scheduleOutput').innerHTML = '';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('singlesSection').style.display = 'none';

            let bestSchedule = null;
            let bestScore = -Infinity;

            const chunkSize = 100;
            const chunks = Math.ceil(iterations / chunkSize);

            for (let c = 0; c < chunks; c++) {
                document.getElementById('progressFill').style.width = `${((c + 1) / chunks) * 100}%`;

                for (let i = 0; i < chunkSize; i++) {
                    const result = buildSchedule();
                    const scoreResult = calculateScore(result);

                    if (scoreResult.score > bestScore) {
                        bestScore = scoreResult.score;
                        bestSchedule = { ...result, scoreResult };
                    }
                }

                await new Promise(r => setTimeout(r, 0));
            }

            currentSchedule = bestSchedule;
            renderSchedule(bestSchedule);

            document.getElementById('loading').style.display = 'none';
        }

        // Build player-to-partner map for each week
        function buildPlayerMap(result) {
            const playerMap = {}; // week -> player -> value

            for (let w = 1; w <= state.weekCount; w++) {
                const week = String(w);
                const weekType = state.weekTypes[week] || 'regular';
                const weekData = result.schedule[week] || [];
                
                playerMap[week] = {};

                // Off weeks: everyone is NOT PLAYING
                if (weekType === 'off') {
                    state.players.forEach(p => {
                        playerMap[week][p] = 'NOT PLAYING';
                    });
                    continue;
                }

                // Scramble/Best Ball: everyone available is PLAYING
                if (weekType === 'scramble' || weekType === 'bestball') {
                    const available = state.availability[week] || [];
                    state.players.forEach(p => {
                        if (available.includes(p)) {
                            playerMap[week][p] = 'PLAYING';
                        } else {
                            playerMap[week][p] = 'NOT PLAYING';
                        }
                    });
                    continue;
                }

                // Regular/Aggregate/Tournament: show partner or ALONE or NOT PLAYING
                const available = state.availability[week] || [];
                
                // Initialize all as NOT PLAYING
                state.players.forEach(p => {
                    if (available.includes(p)) {
                        playerMap[week][p] = 'ALONE'; // Default if available but unpaired
                    } else {
                        playerMap[week][p] = 'NOT PLAYING';
                    }
                });

                // Process pairings
                weekData.forEach(item => {
                    if (item.sitout) {
                        playerMap[week][item.sitout] = 'ALONE';
                    } else if (item.a && item.b) {
                        // Mirrored: A shows B, B shows A
                        playerMap[week][item.a] = item.b;
                        playerMap[week][item.b] = item.a;
                    }
                });
            }

            return playerMap;
        }

        function renderSchedule(result) {
            const output = document.getElementById('scheduleOutput');
            const playerMap = buildPlayerMap(result);

            // Build player-column table
            let html = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th class="week-info-header">Week / Date / Course</th>
                            <th class="type-header">Type</th>
            `;

            // Player column headers (fixed order)
            state.players.forEach((p, idx) => {
                html += `<th class="player-header">${p}</th>`;
            });

            html += `
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (let w = 1; w <= state.weekCount; w++) {
                const week = String(w);
                const weekType = state.weekTypes[week] || 'regular';
                const weekDate = state.weekDates[week] || '';
                const weekName = state.weekNames[week] || '';

                html += `<tr class="week-row ${weekType}">`;

                // Week info cell (stacked: week number, date, course)
                html += `<td class="week-info-cell">`;
                html += `<span class="week-num">Week ${w}</span>`;
                if (weekDate) {
                    const dateFormatted = new Date(weekDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    html += `<span class="week-date">${dateFormatted}</span>`;
                }
                if (weekName) {
                    html += `<span class="week-course">${weekName}</span>`;
                }
                html += `</td>`;

                // Type cell (vertical text)
                html += `<td class="type-cell ${weekType}">${EVENT_LABELS[weekType]}</td>`;

                // Player cells
                state.players.forEach(player => {
                    const value = playerMap[week][player] || 'NOT PLAYING';
                    let cellClass = 'player-cell';
                    
                    if (value === 'NOT PLAYING') {
                        cellClass += ' not-playing';
                    } else if (value === 'ALONE') {
                        cellClass += ' alone';
                    } else if (value === 'PLAYING') {
                        cellClass += ' playing';
                    } else {
                        cellClass += ' partner';
                    }

                    html += `<td class="${cellClass}">${value}</td>`;
                });

                html += `</tr>`;
            }

            html += '</tbody></table>';
            output.innerHTML = html;

            // Render singles summary
            renderSinglesSummary(result);

            // Update stats
            const stats = result.scoreResult.stats;
            document.getElementById('statUnique').textContent = stats.uniquePairs;
            document.getElementById('statSingles').textContent = stats.totalSitouts;
            document.getElementById('statPreferred').textContent = stats.preferredUsed;
            document.getElementById('statRepeats').textContent = stats.pairRepeats;
            document.getElementById('scoreValue').textContent = result.scoreResult.score;
            document.getElementById('statsSection').style.display = 'block';
        }

        function renderSinglesSummary(result) {
            const section = document.getElementById('singlesSection');
            
            const singlesData = [];
            result.sitOuts.forEach((count, player) => {
                if (count > 0) {
                    const weeks = result.sitOutWeeks.get(player) || [];
                    singlesData.push({ player, count, weeks });
                }
            });

            if (singlesData.length === 0) {
                section.style.display = 'none';
                return;
            }

            singlesData.sort((a, b) => b.count - a.count);

            let html = `
                <div class="singles-summary">
                    <h4>üèåÔ∏è Playing Alone Summary</h4>
                    <table class="singles-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Times Alone</th>
                                <th>Weeks</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            singlesData.forEach(({ player, count, weeks }) => {
                let countClass = 'low';
                if (count >= 3) countClass = 'high';
                else if (count >= 2) countClass = 'medium';

                const weekLabels = weeks.map(w => {
                    const name = state.weekNames[String(w)];
                    return name ? `W${w} (${name})` : `W${w}`;
                }).join(', ');

                html += `
                    <tr>
                        <td>${player}</td>
                        <td class="count ${countClass}">${count}</td>
                        <td class="weeks">${weekLabels}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            section.innerHTML = html;
            section.style.display = 'block';
        }

        // Load Example
        function loadExample() {
            state.players = ['Scott', 'Mark', 'GaryS', 'Greg', 'Ken', 'Bob', 'Chris', 'Dave'];
            state.weekCount = 8;
            state.weekTypes = {
                '1': 'regular',
                '2': 'aggregate',
                '3': 'scramble',
                '4': 'tournament',
                '5': 'regular',
                '6': 'bestball',
                '7': 'off',
                '8': 'aggregate'
            };
            state.weekDates = {
                '1': '2025-03-01',
                '2': '2025-03-08',
                '3': '2025-03-15',
                '4': '2025-03-22',
                '5': '2025-03-29',
                '6': '2025-04-05',
                '7': '2025-04-12',
                '8': '2025-04-19'
            };
            state.weekNames = {
                '1': 'Pine Valley',
                '2': 'Augusta',
                '3': 'Pebble Beach',
                '4': 'St Andrews',
                '5': 'Sawgrass',
                '6': 'Royal Troon',
                '7': 'Memorial Day',
                '8': 'Pinehurst'
            };
            state.availability = {
                '1': ['Scott', 'Mark', 'GaryS', 'Greg', 'Bob', 'Chris'],
                '2': ['Scott', 'Mark', 'Ken', 'Bob', 'Dave'],
                '3': ['Scott', 'GaryS', 'Ken', 'Bob', 'Chris', 'Dave'],
                '4': ['Scott', 'Mark', 'Greg', 'Ken', 'Chris', 'Dave'],
                '5': ['Scott', 'Mark', 'GaryS', 'Ken', 'Bob', 'Chris'],
                '6': ['GaryS', 'Greg', 'Ken', 'Bob', 'Dave', 'Chris'],
                '8': ['Scott', 'Mark', 'GaryS', 'Greg', 'Ken', 'Bob']
            };
            state.preferredPairs = new Map([['Mark|Scott', 2], ['GaryS|Greg', 3]]);
            state.forbiddenPairs = new Set(['Greg|Scott']);
            state.tournamentPairings = {
                '4': [
                    { a: 'Scott', b: 'Mark' },
                    { a: 'Greg', b: 'Ken' },
                    { a: 'Chris', b: 'Dave' }
                ]
            };

            document.getElementById('weekCount').value = 8;
            renderPlayers();
            renderWeekConfig();
            updateAvailabilityGrid();
            updatePlayerSelects();
            renderPreferredPairs();
            renderForbiddenPairs();
            updateTournamentSection();
        }

        // Clear All
        function clearAll() {
            state = {
                players: [],
                weekCount: 6,
                weekTypes: {},
                weekDates: {},
                weekNames: {},
                availability: {},
                preferredPairs: new Map(),
                forbiddenPairs: new Set(),
                tournamentPairings: {}
            };
            currentSchedule = null;

            document.getElementById('weekCount').value = 6;
            renderPlayers();
            renderWeekConfig();
            updateAvailabilityGrid();
            updatePlayerSelects();
            renderPreferredPairs();
            renderForbiddenPairs();
            updateTournamentSection();
            document.getElementById('scheduleOutput').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>Configure players and weeks, then click Generate Schedule</p></div>';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('singlesSection').style.display = 'none';
        }

        // Copy Output
        function copyOutput() {
            if (!currentSchedule) {
                alert('Generate a schedule first');
                return;
            }
            const text = document.getElementById('scheduleOutput').innerText;
            navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
        }

        // Export CSV - Player column format
        function exportCSV() {
            if (!currentSchedule) {
                alert('Generate a schedule first');
                return;
            }

            const playerMap = buildPlayerMap(currentSchedule);

            // Header row
            let csv = 'Week,Date,Course,Type';
            state.players.forEach(p => {
                csv += `,"${p}"`;
            });
            csv += '\n';

            // Data rows
            for (let w = 1; w <= state.weekCount; w++) {
                const week = String(w);
                const weekType = state.weekTypes[week] || 'regular';
                const weekDate = state.weekDates[week] || '';
                const weekName = state.weekNames[week] || '';

                csv += `${w},"${weekDate}","${weekName}","${EVENT_LABELS[weekType]}"`;

                state.players.forEach(p => {
                    const value = playerMap[week][p] || 'NOT PLAYING';
                    csv += `,"${value}"`;
                });

                csv += '\n';
            }

            csv += '\nPlaying Alone Summary\nPlayer,Times Alone,Weeks\n';
            currentSchedule.sitOuts.forEach((count, player) => {
                if (count > 0) {
                    const weeks = currentSchedule.sitOutWeeks.get(player).join('; ');
                    csv += `"${player}",${count},"${weeks}"\n`;
                }
            });

            csv += '\nStatistics\nMetric,Value\n';
            csv += `Unique Pairings,${currentSchedule.scoreResult.stats.uniquePairs}\n`;
            csv += `Times Playing Alone,${currentSchedule.scoreResult.stats.totalSitouts}\n`;
            csv += `Preferred Pairs Used,${currentSchedule.scoreResult.stats.preferredUsed}\n`;
            csv += `Pairing Repeats,${currentSchedule.scoreResult.stats.pairRepeats}\n`;
            csv += `Optimization Score,${currentSchedule.scoreResult.score}\n`;

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `golf_schedule_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Keyboard shortcut
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                generateSchedule();
            }
        });
    </script>
</body>
</html>
