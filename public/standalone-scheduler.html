<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Group Scheduler</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-primary: #22c55e;
            --accent-secondary: #16a34a;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-tournament: #8b5cf6;
            --border-color: #475569;
            --radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        h1 {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--accent-primary), #4ade80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle { color: var(--text-secondary); font-size: 1rem; }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 28px;
        }

        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        .btn-primary:hover { background: var(--accent-secondary); }

        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-outline:hover { background: var(--bg-tertiary); }

        .btn-sm { padding: 6px 14px; font-size: 0.8rem; }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        input[type="text"], input[type="number"] {
            flex: 1;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .player-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 0.9rem;
        }
        .tag-remove:hover { opacity: 1; color: var(--accent-danger); }

        .week-selector {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .week-input {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        .week-input input {
            width: 70px;
            text-align: center;
        }

        .week-config-grid {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 8px;
            margin-top: 12px;
            align-items: center;
        }

        .week-config-header {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            padding-bottom: 4px;
        }

        .week-name-input {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.8rem;
            width: 100%;
        }

        .week-chip {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            text-align: center;
        }

        .week-chip.aggregate {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--accent-warning);
            color: var(--accent-warning);
        }

        .week-chip.tournament {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--accent-tournament);
            color: var(--accent-tournament);
        }

        .week-label {
            font-size: 0.85rem;
            font-weight: 500;
            min-width: 50px;
        }

        .availability-grid {
            overflow-x: auto;
        }

        .availability-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .availability-table th,
        .availability-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .availability-table th {
            background: var(--bg-tertiary);
            font-weight: 500;
        }

        .availability-table th.tournament {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent-tournament);
        }

        .availability-table th.aggregate {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
        }

        .availability-table td {
            cursor: pointer;
            transition: background 0.2s;
        }

        .availability-table td.available {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-primary);
        }

        .availability-table td:hover {
            background: var(--bg-tertiary);
        }

        .pair-section {
            margin-bottom: 18px;
        }

        .pair-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .pair-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .pair-tag.preferred {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--accent-primary);
        }

        .pair-tag.forbidden {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-danger);
        }

        select {
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 14px;
        }

        .iteration-control {
            display: flex;
            align-items: center;
            gap: 14px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        input[type="range"] {
            width: 140px;
            accent-color: var(--accent-primary);
        }

        .iteration-value {
            color: var(--accent-primary);
            font-weight: 600;
            min-width: 50px;
        }

        .schedule-output {
            min-height: 300px;
            max-height: 600px;
            overflow: auto;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* Schedule Table Styles */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .schedule-table th,
        .schedule-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        .schedule-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .schedule-table tr.week-row {
            background: rgba(30, 41, 59, 0.5);
        }

        .schedule-table tr.week-row:hover {
            background: rgba(30, 41, 59, 0.8);
        }

        .schedule-table tr.week-row.aggregate {
            border-left: 4px solid var(--accent-warning);
        }

        .schedule-table tr.week-row.tournament {
            border-left: 4px solid var(--accent-tournament);
        }

        .schedule-table .week-cell {
            font-weight: 600;
            white-space: nowrap;
        }

        .schedule-table .week-name {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: normal;
            display: block;
            margin-top: 2px;
        }

        .schedule-table .pairings-cell {
            color: var(--accent-primary);
        }

        .schedule-table .pairings-cell .pair {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .schedule-table .pairings-cell .pair.repeat {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        .schedule-table .sitouts-cell {
            color: var(--accent-danger);
        }

        .schedule-table .sitouts-cell .sitout {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: rgba(239, 68, 68, 0.15);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .schedule-table .badges-cell {
            white-space: nowrap;
        }

        .week-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-right: 4px;
        }

        .week-badge.aggregate {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .week-badge.tournament {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent-tournament);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        /* Sitout Summary Table */
        .sitout-summary {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .sitout-summary h4 {
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: var(--accent-danger);
        }

        .sitout-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .sitout-table th,
        .sitout-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .sitout-table th {
            background: var(--bg-secondary);
            font-weight: 500;
        }

        .sitout-table td.count {
            text-align: center;
            font-weight: 600;
        }

        .sitout-table td.count.high {
            color: var(--accent-danger);
        }

        .sitout-table td.count.medium {
            color: var(--accent-warning);
        }

        .sitout-table td.count.low {
            color: var(--accent-primary);
        }

        .sitout-table td.weeks {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 18px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .score-display {
            text-align: center;
            padding: 18px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 10px;
        }

        .score-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .score-value {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), #4ade80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .export-btns {
            display: flex;
            gap: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            height: 3px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), #4ade80);
            width: 0;
            transition: width 0.3s;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .separator {
            height: 1px;
            background: var(--border-color);
            margin: 20px 0;
        }

        .scroll-area {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .legend {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 0.8rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-dot.aggregate {
            background: rgba(245, 158, 11, 0.5);
            border: 1px solid var(--accent-warning);
        }

        .legend-dot.tournament {
            background: rgba(139, 92, 246, 0.5);
            border: 1px solid var(--accent-tournament);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚õ≥ Golf Group Scheduler</h1>
            <p class="subtitle">Optimize pairings for golf or any group activity</p>
        </header>

        <div class="main-grid">
            <!-- Configuration Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚öôÔ∏è Configuration</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-outline btn-sm" onclick="loadExample()">üìÑ Example</button>
                        <button class="btn btn-outline btn-sm" onclick="clearAll()">üóëÔ∏è Clear</button>
                    </div>
                </div>

                <div class="scroll-area">
                    <!-- Players Section -->
                    <div class="section">
                        <div class="section-title">üë• Players</div>
                        <div class="input-row">
                            <input type="text" id="newPlayer" placeholder="Enter player name..." onkeypress="if(event.key==='Enter')addPlayer()">
                            <button class="btn btn-primary btn-sm" onclick="addPlayer()">+ Add</button>
                        </div>
                        <div class="player-tags" id="playerTags"></div>
                    </div>

                    <div class="separator"></div>

                    <!-- Weeks Section -->
                    <div class="section">
                        <div class="section-title">üìÖ Weeks Configuration</div>
                        <div class="week-selector">
                            <div class="week-input">
                                <span>Number of weeks:</span>
                                <input type="number" id="weekCount" value="6" min="1" max="52" onchange="updateWeeks()">
                            </div>
                        </div>
                        <div class="legend" style="margin-top: 12px;">
                            <div class="legend-item">
                                <div class="legend-dot aggregate"></div>
                                <span>Aggregate (scoring)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot tournament"></div>
                                <span>Tournament</span>
                            </div>
                        </div>
                        <div class="week-config-grid" id="weekConfigGrid">
                            <div class="week-config-header">Week</div>
                            <div class="week-config-header">Place/Name</div>
                            <div class="week-config-header">Aggr.</div>
                            <div class="week-config-header">Tourn.</div>
                        </div>
                    </div>

                    <div class="separator"></div>

                    <!-- Availability Section -->
                    <div class="section">
                        <div class="section-title">‚úì Availability</div>
                        <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">Click cells to toggle availability</p>
                        <div class="availability-grid">
                            <table class="availability-table" id="availabilityTable"></table>
                        </div>
                    </div>

                    <div class="separator"></div>

                    <!-- Pair Preferences Section -->
                    <div class="section">
                        <div class="section-title">üíö Preferred Pairs</div>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px;">Preferred pairs are prioritized on aggregate weeks</p>
                        <div class="input-row">
                            <select id="preferred1"></select>
                            <select id="preferred2"></select>
                            <input type="number" id="preferredMax" value="2" min="1" max="10" style="width: 60px;" placeholder="Max">
                            <button class="btn btn-primary btn-sm" onclick="addPreferredPair()">+ Add</button>
                        </div>
                        <div class="pair-list" id="preferredPairs"></div>
                    </div>

                    <div class="section">
                        <div class="section-title">üö´ Forbidden Pairs</div>
                        <div class="input-row">
                            <select id="forbidden1"></select>
                            <select id="forbidden2"></select>
                            <button class="btn btn-outline btn-sm" onclick="addForbiddenPair()">+ Add</button>
                        </div>
                        <div class="pair-list" id="forbiddenPairs"></div>
                    </div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìã Schedule Output</div>
                    <div class="export-btns">
                        <button class="btn btn-outline btn-sm" onclick="copyOutput()">üìã Copy</button>
                        <button class="btn btn-primary btn-sm" onclick="exportCSV()">üì• Export CSV</button>
                    </div>
                </div>

                <div class="controls-bar">
                    <div class="iteration-control">
                        <span>Iterations:</span>
                        <input type="range" id="iterations" min="100" max="10000" value="2000" step="100" oninput="updateIterationDisplay()">
                        <span class="iteration-value" id="iterationDisplay">2000</span>
                    </div>
                    <button class="btn btn-primary" onclick="generateSchedule()">üöÄ Generate Schedule</button>
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Generating optimal schedule...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="schedule-output" id="scheduleOutput">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Configure players and weeks, then click Generate Schedule</p>
                    </div>
                </div>

                <div id="sitoutSection" style="display: none;"></div>

                <div id="statsSection" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statUnique">0</div>
                            <div class="stat-label">Unique Pairings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statSitouts">0</div>
                            <div class="stat-label">Total Sit-outs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statPreferred">0</div>
                            <div class="stat-label">Preferred Pairs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statRepeats">0</div>
                            <div class="stat-label">Pair Repeats</div>
                        </div>
                    </div>
                    <div class="score-display">
                        <div class="score-label">Optimization Score</div>
                        <div class="score-value" id="scoreValue">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            players: [],
            weekCount: 6,
            aggregateWeeks: new Set(),
            tournamentWeeks: new Set(),
            weekNames: {},
            availability: {},
            preferredPairs: new Map(),
            forbiddenPairs: new Set()
        };

        let currentSchedule = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateWeeks();
            updatePlayerSelects();
        });

        // Player Management
        function addPlayer() {
            const input = document.getElementById('newPlayer');
            const name = input.value.trim();
            if (name && !state.players.includes(name)) {
                state.players.push(name);
                input.value = '';
                renderPlayers();
                updateAvailabilityGrid();
                updatePlayerSelects();
            }
        }

        function removePlayer(name) {
            state.players = state.players.filter(p => p !== name);
            // Clean up availability
            for (let week in state.availability) {
                state.availability[week] = state.availability[week].filter(p => p !== name);
            }
            renderPlayers();
            updateAvailabilityGrid();
            updatePlayerSelects();
        }

        function renderPlayers() {
            const container = document.getElementById('playerTags');
            container.innerHTML = state.players.map(p => `
                <span class="tag">
                    ${p}
                    <span class="tag-remove" onclick="removePlayer('${p}')">√ó</span>
                </span>
            `).join('');
        }

        // Week Management
        function updateWeeks() {
            state.weekCount = parseInt(document.getElementById('weekCount').value) || 6;
            // Clean aggregate and tournament weeks
            state.aggregateWeeks = new Set([...state.aggregateWeeks].filter(w => parseInt(w) <= state.weekCount));
            state.tournamentWeeks = new Set([...state.tournamentWeeks].filter(w => parseInt(w) <= state.weekCount));
            // Clean week names
            const newWeekNames = {};
            for (let i = 1; i <= state.weekCount; i++) {
                if (state.weekNames[String(i)]) {
                    newWeekNames[String(i)] = state.weekNames[String(i)];
                }
            }
            state.weekNames = newWeekNames;
            
            renderWeekConfig();
            updateAvailabilityGrid();
        }

        function renderWeekConfig() {
            const container = document.getElementById('weekConfigGrid');
            let html = `
                <div class="week-config-header">Week</div>
                <div class="week-config-header">Place/Name</div>
                <div class="week-config-header">Aggr.</div>
                <div class="week-config-header">Tourn.</div>
            `;
            
            for (let i = 1; i <= state.weekCount; i++) {
                const weekKey = String(i);
                const isAggregate = state.aggregateWeeks.has(weekKey);
                const isTournament = state.tournamentWeeks.has(weekKey);
                const weekName = state.weekNames[weekKey] || '';
                
                html += `
                    <span class="week-label">Week ${i}</span>
                    <input type="text" class="week-name-input" value="${weekName}" 
                        placeholder="e.g., Pine Valley" 
                        onchange="updateWeekName('${weekKey}', this.value)">
                    <span class="week-chip ${isAggregate ? 'aggregate' : ''}" 
                        onclick="toggleAggregate(${i})">‚≠ê</span>
                    <span class="week-chip ${isTournament ? 'tournament' : ''}" 
                        onclick="toggleTournament(${i})">üèÜ</span>
                `;
            }
            container.innerHTML = html;
        }

        function updateWeekName(week, name) {
            if (name.trim()) {
                state.weekNames[week] = name.trim();
            } else {
                delete state.weekNames[week];
            }
        }

        function toggleAggregate(week) {
            const key = String(week);
            if (state.aggregateWeeks.has(key)) {
                state.aggregateWeeks.delete(key);
            } else {
                state.aggregateWeeks.add(key);
            }
            renderWeekConfig();
            updateAvailabilityGrid();
        }

        function toggleTournament(week) {
            const key = String(week);
            if (state.tournamentWeeks.has(key)) {
                state.tournamentWeeks.delete(key);
            } else {
                state.tournamentWeeks.add(key);
            }
            renderWeekConfig();
            updateAvailabilityGrid();
        }

        // Availability Grid
        function updateAvailabilityGrid() {
            const table = document.getElementById('availabilityTable');
            if (state.players.length === 0) {
                table.innerHTML = '<tr><td style="padding: 20px; color: var(--text-secondary);">Add players first</td></tr>';
                return;
            }

            let html = '<tr><th>Player</th>';
            for (let i = 1; i <= state.weekCount; i++) {
                const weekKey = String(i);
                const isAggregate = state.aggregateWeeks.has(weekKey);
                const isTournament = state.tournamentWeeks.has(weekKey);
                let thClass = '';
                if (isTournament) thClass = 'tournament';
                else if (isAggregate) thClass = 'aggregate';
                
                const weekName = state.weekNames[weekKey];
                const label = weekName ? `W${i}` : `W${i}`;
                const title = weekName ? `Week ${i}: ${weekName}` : `Week ${i}`;
                html += `<th class="${thClass}" title="${title}">${label}</th>`;
            }
            html += '</tr>';

            state.players.forEach(player => {
                html += `<tr><td style="text-align: left; font-weight: 500;">${player}</td>`;
                for (let i = 1; i <= state.weekCount; i++) {
                    const week = String(i);
                    const isAvailable = state.availability[week]?.includes(player);
                    html += `<td class="${isAvailable ? 'available' : ''}" onclick="toggleAvailability('${player}', '${week}')">${isAvailable ? '‚úì' : ''}</td>`;
                }
                html += '</tr>';
            });

            table.innerHTML = html;
        }

        function toggleAvailability(player, week) {
            if (!state.availability[week]) {
                state.availability[week] = [];
            }
            const idx = state.availability[week].indexOf(player);
            if (idx >= 0) {
                state.availability[week].splice(idx, 1);
            } else {
                state.availability[week].push(player);
            }
            updateAvailabilityGrid();
        }

        // Player Selects for Pairs
        function updatePlayerSelects() {
            const selects = ['preferred1', 'preferred2', 'forbidden1', 'forbidden2'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">Select player</option>' +
                    state.players.map(p => `<option value="${p}">${p}</option>`).join('');
            });
        }

        // Preferred Pairs
        function addPreferredPair() {
            const p1 = document.getElementById('preferred1').value;
            const p2 = document.getElementById('preferred2').value;
            const max = parseInt(document.getElementById('preferredMax').value) || 2;

            if (p1 && p2 && p1 !== p2) {
                const key = [p1, p2].sort().join('|');
                state.preferredPairs.set(key, max);
                renderPreferredPairs();
            }
        }

        function removePreferredPair(key) {
            state.preferredPairs.delete(key);
            renderPreferredPairs();
        }

        function renderPreferredPairs() {
            const container = document.getElementById('preferredPairs');
            const pairs = [...state.preferredPairs.entries()];
            container.innerHTML = pairs.map(([key, max]) => {
                const [p1, p2] = key.split('|');
                return `<span class="pair-tag preferred">
                    ${p1} + ${p2} (max ${max})
                    <span class="tag-remove" onclick="removePreferredPair('${key}')">√ó</span>
                </span>`;
            }).join('');
        }

        // Forbidden Pairs
        function addForbiddenPair() {
            const p1 = document.getElementById('forbidden1').value;
            const p2 = document.getElementById('forbidden2').value;

            if (p1 && p2 && p1 !== p2) {
                const key = [p1, p2].sort().join('|');
                state.forbiddenPairs.add(key);
                renderForbiddenPairs();
            }
        }

        function removeForbiddenPair(key) {
            state.forbiddenPairs.delete(key);
            renderForbiddenPairs();
        }

        function renderForbiddenPairs() {
            const container = document.getElementById('forbiddenPairs');
            const pairs = [...state.forbiddenPairs];
            container.innerHTML = pairs.map(key => {
                const [p1, p2] = key.split('|');
                return `<span class="pair-tag forbidden">
                    ${p1} + ${p2}
                    <span class="tag-remove" onclick="removeForbiddenPair('${key}')">√ó</span>
                </span>`;
            }).join('');
        }

        // Iteration Display
        function updateIterationDisplay() {
            document.getElementById('iterationDisplay').textContent = document.getElementById('iterations').value;
        }

        // Schedule Generation
        function buildSchedule() {
            const schedule = {};
            const pairCounts = new Map();
            const sitOuts = new Map();
            const sitOutWeeks = new Map(); // Track which weeks each player sits out

            state.players.forEach(p => {
                sitOuts.set(p, 0);
                sitOutWeeks.set(p, []);
            });

            for (let w = 1; w <= state.weekCount; w++) {
                const week = String(w);
                const available = [...(state.availability[week] || [])];
                if (available.length === 0) continue;

                const isAggregateWeek = state.aggregateWeeks.has(week);
                const pairings = [];
                const shuffled = [...available].sort(() => Math.random() - 0.5);
                const paired = new Set();

                for (let i = 0; i < shuffled.length; i++) {
                    if (paired.has(shuffled[i])) continue;

                    let bestPartner = null;
                    let bestScore = -Infinity;

                    for (let j = i + 1; j < shuffled.length; j++) {
                        if (paired.has(shuffled[j])) continue;

                        const a = shuffled[i], b = shuffled[j];
                        const key = [a, b].sort().join('|');

                        if (state.forbiddenPairs.has(key)) continue;

                        let score = 0;
                        const count = pairCounts.get(key) || 0;

                        if (count === 0) score += 10;

                        // Preferred pairs get MUCH higher priority on aggregate weeks
                        const limit = state.preferredPairs.get(key);
                        if (limit && count < limit) {
                            score += isAggregateWeek ? 25 : 5; // Higher bonus on aggregate weeks
                        }

                        if (count > 0) score -= count * 3;

                        if (score > bestScore) {
                            bestScore = score;
                            bestPartner = j;
                        }
                    }

                    if (bestPartner !== null) {
                        const a = shuffled[i], b = shuffled[bestPartner];
                        const key = [a, b].sort().join('|');
                        pairings.push({ a, b });
                        paired.add(a);
                        paired.add(b);
                        pairCounts.set(key, (pairCounts.get(key) || 0) + 1);
                    }
                }

                shuffled.filter(p => !paired.has(p)).forEach(p => {
                    pairings.push({ sitout: p });
                    sitOuts.set(p, (sitOuts.get(p) || 0) + 1);
                    sitOutWeeks.get(p).push(w);
                });

                schedule[week] = pairings;
            }

            return { schedule, pairCounts, sitOuts, sitOutWeeks };
        }

        function calculateScore(result) {
            let score = 0;
            const { pairCounts, sitOuts } = result;

            let uniquePairs = 0;
            pairCounts.forEach((count) => {
                if (count === 1) { score += 16; uniquePairs++; }
                else if (count === 2) score += 8;
                else score -= (count - 2) * 3;
            });

            let totalSitouts = 0;
            sitOuts.forEach(count => {
                totalSitouts += count;
                if (count === 0) score += 6;
                else if (count === 1) score += 3;
                else score -= (count - 1) * 6;
            });

            let preferredUsed = 0;
            state.preferredPairs.forEach((limit, key) => {
                const count = pairCounts.get(key) || 0;
                if (count > 0 && count <= limit) {
                    score += 7 * (limit - count + 1);
                    preferredUsed += count;
                } else if (count > limit) {
                    score -= (count - limit) * 50;
                }
            });

            state.forbiddenPairs.forEach(key => {
                const count = pairCounts.get(key) || 0;
                if (count > 0) score -= count * 100;
            });

            const pairRepeats = [...pairCounts.values()].reduce((a, b) => a + Math.max(0, b - 1), 0);

            return {
                score: Math.round(score),
                stats: { uniquePairs, totalSitouts, preferredUsed, pairRepeats }
            };
        }

        async function generateSchedule() {
            if (state.players.length < 2) {
                alert('Please add at least 2 players');
                return;
            }

            const iterations = parseInt(document.getElementById('iterations').value);

            document.getElementById('loading').style.display = 'block';
            document.getElementById('scheduleOutput').innerHTML = '';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('sitoutSection').style.display = 'none';

            let bestSchedule = null;
            let bestScore = -Infinity;

            const chunkSize = 100;
            const chunks = Math.ceil(iterations / chunkSize);

            for (let c = 0; c < chunks; c++) {
                document.getElementById('progressFill').style.width = `${((c + 1) / chunks) * 100}%`;

                for (let i = 0; i < chunkSize; i++) {
                    const result = buildSchedule();
                    const scoreResult = calculateScore(result);

                    if (scoreResult.score > bestScore) {
                        bestScore = scoreResult.score;
                        bestSchedule = { ...result, scoreResult };
                    }
                }

                await new Promise(r => setTimeout(r, 0));
            }

            currentSchedule = bestSchedule;
            renderSchedule(bestSchedule);

            document.getElementById('loading').style.display = 'none';
        }

        function renderSchedule(result) {
            const output = document.getElementById('scheduleOutput');
            
            // Build table output
            let html = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Pairings</th>
                            <th>Sit-outs</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (let w = 1; w <= state.weekCount; w++) {
                const week = String(w);
                const weekData = result.schedule[week];
                if (!weekData) continue;

                const isAggregate = state.aggregateWeeks.has(week);
                const isTournament = state.tournamentWeeks.has(week);
                const weekName = state.weekNames[week];
                
                let rowClass = 'week-row';
                if (isTournament) rowClass += ' tournament';
                else if (isAggregate) rowClass += ' aggregate';

                // Collect pairings and sitouts
                const pairings = [];
                const sitouts = [];
                
                weekData.forEach(item => {
                    if (item.sitout) {
                        sitouts.push(item.sitout);
                    } else {
                        const key = [item.a, item.b].sort().join('|');
                        const count = result.pairCounts.get(key) || 0;
                        pairings.push({ a: item.a, b: item.b, count });
                    }
                });

                html += `<tr class="${rowClass}">`;
                
                // Week column
                html += `<td class="week-cell">Week ${w}`;
                if (weekName) {
                    html += `<span class="week-name">${weekName}</span>`;
                }
                html += `</td>`;
                
                // Pairings column
                html += `<td class="pairings-cell">`;
                pairings.forEach(p => {
                    const repeatClass = p.count > 1 ? 'repeat' : '';
                    html += `<span class="pair ${repeatClass}" title="${p.count} time(s)">${p.a} + ${p.b}</span>`;
                });
                html += `</td>`;
                
                // Sitouts column
                html += `<td class="sitouts-cell">`;
                sitouts.forEach(s => {
                    const totalSitouts = result.sitOuts.get(s) || 0;
                    html += `<span class="sitout" title="Total: ${totalSitouts}">${s}</span>`;
                });
                if (sitouts.length === 0) {
                    html += `<span style="color: var(--text-secondary); font-size: 0.8rem;">None</span>`;
                }
                html += `</td>`;
                
                // Type badges column
                html += `<td class="badges-cell">`;
                if (isTournament) {
                    html += `<span class="week-badge tournament">üèÜ Tournament</span>`;
                }
                if (isAggregate) {
                    html += `<span class="week-badge aggregate">‚≠ê Aggregate</span>`;
                }
                html += `</td>`;
                
                html += `</tr>`;
            }

            html += '</tbody></table>';
            output.innerHTML = html || '<div class="empty-state"><p>No schedule generated</p></div>';

            // Render sitout summary
            renderSitoutSummary(result);

            // Update stats
            const stats = result.scoreResult.stats;
            document.getElementById('statUnique').textContent = stats.uniquePairs;
            document.getElementById('statSitouts').textContent = stats.totalSitouts;
            document.getElementById('statPreferred').textContent = stats.preferredUsed;
            document.getElementById('statRepeats').textContent = stats.pairRepeats;
            document.getElementById('scoreValue').textContent = result.scoreResult.score;
            document.getElementById('statsSection').style.display = 'block';
        }

        function renderSitoutSummary(result) {
            const section = document.getElementById('sitoutSection');
            
            // Build sitout summary table
            const sitoutData = [];
            result.sitOuts.forEach((count, player) => {
                if (count > 0) {
                    const weeks = result.sitOutWeeks.get(player) || [];
                    sitoutData.push({ player, count, weeks });
                }
            });

            if (sitoutData.length === 0) {
                section.style.display = 'none';
                return;
            }

            // Sort by count descending
            sitoutData.sort((a, b) => b.count - a.count);

            let html = `
                <div class="sitout-summary">
                    <h4>ü™ë Sit-out Summary</h4>
                    <table class="sitout-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Total</th>
                                <th>Weeks</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sitoutData.forEach(({ player, count, weeks }) => {
                let countClass = 'low';
                if (count >= 3) countClass = 'high';
                else if (count >= 2) countClass = 'medium';

                const weekLabels = weeks.map(w => {
                    const name = state.weekNames[String(w)];
                    return name ? `W${w} (${name})` : `W${w}`;
                }).join(', ');

                html += `
                    <tr>
                        <td>${player}</td>
                        <td class="count ${countClass}">${count}</td>
                        <td class="weeks">${weekLabels}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            section.innerHTML = html;
            section.style.display = 'block';
        }

        // Load Example
        function loadExample() {
            state.players = ['Scott', 'Mark', 'GaryS', 'Greg', 'Ken', 'Bob'];
            state.weekCount = 6;
            state.aggregateWeeks = new Set(['2', '4', '6']);
            state.tournamentWeeks = new Set(['4']);
            state.weekNames = {
                '1': 'Pine Valley',
                '2': 'Augusta',
                '3': 'Pebble Beach',
                '4': 'St Andrews',
                '5': 'Sawgrass',
                '6': 'Royal Troon'
            };
            state.availability = {
                '1': ['Scott', 'Mark', 'GaryS', 'Greg', 'Bob'],
                '2': ['Scott', 'Mark', 'Ken', 'Bob'],
                '3': ['Scott', 'GaryS', 'Ken', 'Bob'],
                '4': ['Scott', 'Mark', 'Greg', 'Ken'],
                '5': ['Scott', 'Mark', 'GaryS', 'Ken', 'Bob'],
                '6': ['GaryS', 'Greg', 'Ken', 'Bob']
            };
            state.preferredPairs = new Map([['Mark|Scott', 2], ['GaryS|Greg', 3]]);
            state.forbiddenPairs = new Set(['Greg|Scott']);

            document.getElementById('weekCount').value = 6;
            renderPlayers();
            renderWeekConfig();
            updateAvailabilityGrid();
            updatePlayerSelects();
            renderPreferredPairs();
            renderForbiddenPairs();
        }

        // Clear All
        function clearAll() {
            state = {
                players: [],
                weekCount: 6,
                aggregateWeeks: new Set(),
                tournamentWeeks: new Set(),
                weekNames: {},
                availability: {},
                preferredPairs: new Map(),
                forbiddenPairs: new Set()
            };
            currentSchedule = null;

            document.getElementById('weekCount').value = 6;
            renderPlayers();
            renderWeekConfig();
            updateAvailabilityGrid();
            updatePlayerSelects();
            renderPreferredPairs();
            renderForbiddenPairs();
            document.getElementById('scheduleOutput').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>Configure players and weeks, then click Generate Schedule</p></div>';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('sitoutSection').style.display = 'none';
        }

        // Copy Output
        function copyOutput() {
            if (!currentSchedule) {
                alert('Generate a schedule first');
                return;
            }
            const text = document.getElementById('scheduleOutput').innerText;
            navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
        }

        // Export CSV
        function exportCSV() {
            if (!currentSchedule) {
                alert('Generate a schedule first');
                return;
            }

            let csv = 'Week,Week Name,Player1,Player2,Sitout,Aggregate,Tournament\n';

            for (let w = 1; w <= state.weekCount; w++) {
                const week = String(w);
                const weekData = currentSchedule.schedule[week] || [];
                const weekName = state.weekNames[week] || '';
                const isAggregate = state.aggregateWeeks.has(week) ? 'Yes' : 'No';
                const isTournament = state.tournamentWeeks.has(week) ? 'Yes' : 'No';
                
                weekData.forEach(item => {
                    if (item.sitout) {
                        csv += `${week},"${weekName}",,${item.sitout},Yes,${isAggregate},${isTournament}\n`;
                    } else {
                        csv += `${week},"${weekName}",${item.a},${item.b},No,${isAggregate},${isTournament}\n`;
                    }
                });
            }

            csv += '\nSitout Summary\nPlayer,Total Sitouts,Weeks\n';
            currentSchedule.sitOuts.forEach((count, player) => {
                if (count > 0) {
                    const weeks = currentSchedule.sitOutWeeks.get(player).join('; ');
                    csv += `${player},${count},"${weeks}"\n`;
                }
            });

            csv += '\nStatistics\nMetric,Value\n';
            csv += `Unique Pairings,${currentSchedule.scoreResult.stats.uniquePairs}\n`;
            csv += `Total Sitouts,${currentSchedule.scoreResult.stats.totalSitouts}\n`;
            csv += `Preferred Pairs Used,${currentSchedule.scoreResult.stats.preferredUsed}\n`;
            csv += `Pairing Repeats,${currentSchedule.scoreResult.stats.pairRepeats}\n`;
            csv += `Optimization Score,${currentSchedule.scoreResult.score}\n`;

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `schedule_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Keyboard shortcut
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                generateSchedule();
            }
        });
    </script>
</body>
</html>
